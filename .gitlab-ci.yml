# BEGIN job-specific configuration

default:
  cache:
    key: "${CI_PROJECT_PATH_SLUG}"
    paths:
    - "/usr/local/cargo/registry"
  image: "rust:1.53.0-buster"

.default-rule: &default-rule
  only: 
  - "merge-requests"

.build: &build
  extends:
  - ".default-rule"
  script:
  - "make add-fmt release"
  stage: "build"
  when: "manual"

.test: &test
  artifacts:
    expire_in: "7 days"
    paths:
    - "coverage"
    when: "always"
  extends:
  - ".default-rule"
  script:
  - "make test"
  stage: "test"
  when: "manual"

.coverage: &coverage
  artifacts:
    expire_in: "7 days"
    paths:
    - "public/$PACKAGE"
  extends:
  - ".default-rule"
  script:
  - "rm -rf public/$PACKAGE"
  - "mkdir -p public/$PACKAGE"
  - "cp -r coverage/lcov-report/* public/$PACKAGE"
  stage: "coverage"
  when: "manual"

.deploy: &deploy
  extends:
    - ".default-rule"
  image: "docker:20.10.7"
  script:
  - "docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY"
  - "docker pull $CI_REGISTRY_IMAGE/$IMAGE_NAME:latest || true"
  - "docker build --cache-from $CI_REGISTRY_IMAGE/$IMAGE_NAME:latest -f $DOCKERFILE --tag $CI_REGISTRY_IMAGE/$IMAGE_NAME:$CI_COMMIT_SHA --tag $CI_REGISTRY_IMAGE/$IMAGE_NAME:latest ."
  - "docker push $CI_REGISTRY_IMAGE/$IMAGE_NAME:$CI_COMMIT_SHA"
  - "docker push $CI_REGISTRY_IMAGE/$IMAGE_NAME:latest"
  # - "mkdir -p '$MOUNT_POINT'"
  # - "docker run -v "$MOUNT_POINT:/mnt" $IMAGE_NAME /mnt/script/to/run/tests""
  services:
  - "docker:20.10.7-dind-rootlesss"
  stage: "deploy"
  variables:
    DOCKER_DRIVER: "overlay2"
    DOCKER_HOST: "tcp://127.0.0.1:2376"
    DOCKER_TLS_CERTDIR: ""
    # MOUNT_POINT: /builds/$CI_PROJECT_PATH/mnt
    # MOUNT_POINT: "$CI_PROJECT_DIR/mnt"
  when: "manual"

# END job-specific configuration

# BEGIN project-specific configuration

# END project-specific configuration

# BEGIN actual pipeline definition

stages:
- "build"
- "test"
- "coverage"
- "deploy"

include:
- local: "/fip_api/.gitlab-ci.yml"
- local: "/fip_at/.gitlab-ci.yml"
- local: "/fip_jwks/.gitlab-ci.yml"
- local: "/fip_rt/.gitlab-ci.yml"
- local: "/fip_user/.gitlab-ci.yml"

# END actual pipeline definition
